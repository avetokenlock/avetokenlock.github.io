import{C as _e}from"./ContractQuery-60df484a.js";import{I as he}from"./InputQty-07f45d07.js";import{d as $,_ as pe,O as me,S as fe}from"./InputQty.vuevuetypestyleindex0scopedc76ad684lang-1bc5cab1.js";import{T as L}from"./TokenIcon-70b61560.js";import{a as Z,f as P,b as N,c as ye,B as Y}from"./bignumber-0890a5b7.js";import{_ as ee,x as oe,C as we,d as S,o as d,q as B,g as v,h as t,v as e,f as y,c,j as k,t as i,K as te,p as ne,n as se,B as Ce,b as ge,r as m,y as be,E as Ie,F as q,k as h,l as K,I as z,M as J,L as X,T as Se,G as g,N as $e}from"./index-16fefa86.js";const b=r=>(ne("data-v-400a8c98"),r=r(),se(),r),Le={class:"ave-popup"},Te=b(()=>t("div",{class:"title"},"锁定确认",-1)),Ae={class:"body"},De={class:"info"},xe=b(()=>t("div",{class:"key"},"锁定资产",-1)),Be={class:"value"},Pe={key:0,class:"token"},Ne={key:1,class:"token"},Ee={key:2,class:"token"},Me=b(()=>t("div",{class:"key"},"锁定数量",-1)),Ge={class:"value"},Ue=b(()=>t("div",{class:"key"},"所属公链",-1)),Fe={class:"value"},Oe=b(()=>t("div",{class:"key"},"解除锁定",-1)),We={class:"value"},Re={class:"blue-font"},Ve=b(()=>t("div",{class:"key"},"服务费",-1)),Ye={class:"value"},je=b(()=>t("div",{class:"tips"},[t("div",null,"*1, 如代币存在交易限额可能会造成锁定失败;"),t("div",null," 2, 如代币存在交易或转账燃烧, 可能会造成实际锁定数量小于页面显示数量;"),t("div",null," 3, 锁定完成后, 将无法撤回或提前终止锁定。")],-1)),He={__name:"LockConfirmPopup",props:{show:Boolean,showGas:String,amount:String,unlockDate:Date},emits:["update:show","confirm"],setup(r,{emit:f}){const A=r,l=oe(),D=we(()=>{if(!A.unlockDate)return 0;const E=$(A.unlockDate),o=$().startOf("day");return E.diff(o,"day")});function x(){f("confirm")}return(E,o)=>{const F=S("van-button"),w=S("van-popup");return d(),B(w,{show:r.show,"onUpdate:show":o[0]||(o[0]=p=>{f("update:show",p)}),round:"",closeable:"",position:"bottom"},{default:v(()=>[t("div",Le,[Te,t("div",Ae,[t("ul",De,[t("li",null,[xe,t("div",Be,[e(l).token?e(l).token.tokenType==0?(d(),y("div",Ne,[c(L,{class:"token-icon",tokenIcon:e(l).token.icon,chainIcon:e(Z)(e(l).token.chain)},null,8,["tokenIcon","chainIcon"]),k(" "+i(`${e(l).token.symbol} (${e(P)(e(l).token.address)})`),1)])):e(l).token.tokenType==1?(d(),y("div",Ee,[c(L,{class:"token-icon",tokenIcon:e(N)(e(l).token.chain,e(l).token.tokenList[0].address)},null,8,["tokenIcon"]),c(L,{class:"token-icon",tokenIcon:e(N)(e(l).token.chain,e(l).token.tokenList[1].address)},null,8,["tokenIcon"]),k(" "+i(`${e(l).token.symbol} (${e(P)(e(l).token.address)})`),1)])):te("",!0):(d(),y("div",Pe," -- "))])]),t("li",null,[Me,t("div",Ge,i(r.amount),1)]),t("li",null,[Ue,t("div",Fe,i(e(l).token?e(l).token.chain.toUpperCase():"--"),1)]),t("li",null,[Oe,t("div",We,[t("span",null,i(e($)(r.unlockDate).format("YYYY-MM-DD")),1),t("span",null,[k("("),t("span",Re,"剩余"+i(e(D))+"天",1),k(")")])])]),t("li",null,[Ve,t("div",Ye,i(e(l).token&&r.showGas?`${r.showGas} ${e(l).token.chainMainCoinSymbol.toUpperCase()}`:"--"),1)])]),je,c(F,{class:"btn",type:"primary",block:"",onClick:x},{default:v(()=>[k("确认并锁定")]),_:1})])])]),_:1},8,["show"])}}},Qe=ee(He,[["__scopeId","data-v-400a8c98"]]);const T=r=>(ne("data-v-59040cb6"),r=r(),se(),r),qe={class:"body"},Ke={key:0,class:"info"},ze=T(()=>t("div",{class:"key"},"名称",-1)),Je={class:"value"},Xe=T(()=>t("div",{class:"key"},"符号",-1)),Ze={class:"value"},eo=T(()=>t("div",{class:"key"},"合约",-1)),oo={class:"value"},to=T(()=>t("div",{class:"title token-title"},"选择代币",-1)),no={key:0,class:"token-box"},so={key:1,class:"token"},ao={class:"title"},lo=T(()=>t("div",null,"设置锁定数量",-1)),co=T(()=>t("div",{class:"title"},[t("div",null,"设置锁定日期")],-1)),io={__name:"Create",setup(r){const{t:f}=Ce(),A=ge("global"),l=m(!1),D=m(!1),x=m(!1),E=be(),o=oe(),F=$().startOf("day").add(1,"day").toDate(),w=m(F),p=m(""),M=m(!1),j=m(""),O=m(!1),W=m("");function ae(){return A.cfg.allowChainList.map(s=>s.chainId).includes(o.chainId)?!0:(netErrorDialogShow.value=!0,!1)}async function le(){await o.connectWallet()}async function H(){await h.wallet.isAllowanceEnough(o.lockContractAddress,o.token.address,o.walletAddress)?l.value=!1:l.value=!0}async function ce(){D.value=!0;try{let a=await h.wallet.approveMaxAmount(o.token.address,o.lockContractAddress);console.log(a),await a.wait(),l.value=!1}catch(a){console.log(a)}finally{D.value=!1}}async function ie(){x.value=!0,W.value="";try{if(!o.token){g(f("pleaseSelectToken"));return}if(!p.value){g("请输入金额");return}let a=A.cfg.allowChainList.find(_=>_.chain==o.token.chain);if(!a){g(f("tokenChainNotSupport"));return}if(o.chainId!=a.chainId){g(f("switchTokenChain"));return}if(Number(p)>o.token.amount){g(f("blanceSlow"));return}if(await H(),l.value){g(f("approveFirst"));return}await re()}catch(a){console.log(a)}finally{x.value=!1}}async function re(){const a=o.token.address,s=h.wallet.getEthersProvider(),n=await h.wallet.contractByProvider(s,a,z).decimals(),C=o.walletAddress,G=o.token.tokenType==1,u=J(p.value,n),R=$(w.value).unix(),V="",U=h.wallet.contractByProvider(s,o.lockContractAddress,X);console.dir(U);const I=await s.getGasPrice();let Q=await U.estimateGas.lock(C,a,G,u.toString(),R,V);console.dir(Q),j.value=$e(Q.mul(I)).toString(),M.value=!0}async function de(){const a=K({message:"Loading...",forbidClick:!0,duration:0}),s=o.token.address,_=o.walletAddress,n=h.wallet.getEthersProvider(),C=o.token.tokenType==1,u=await h.wallet.contractByProvider(n,s,z).decimals(),R=J(p.value,u),V=$(w.value).unix(),U=h.wallet.contractByProvider(n,o.lockContractAddress,X);try{let I=await U.lock(_,s,C,R.toString(),V,"");console.dir(I),W.value=I.hash,O.value=!0,M.value=!1}catch(I){console.log(I)}finally{a.close()}}function ue(){E.push("/selectToken")}async function ke(a,s){let _=await h.debank.getTokenList(o.walletAddress,a);for(let n of _.data.data)if(n.token=="0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee"&&(n.token=h.wallet.MAIN_COIN_ADDRESS),new RegExp("^0x.*$","gi").test(n.token)&&n.value>0&&n.risk_score<60&&n.risk_level>=0&&n.flag!=="blacklist"&&n.symbol!==""&&n.token.toLowerCase()==s.toLowerCase())return n.flag=="lp"?{tokenList:[{address:"",symbol:""},{address:"",symbol:""}],symbol:"",address:n.token.toLowerCase(),tokenId:`${n.token}-${n.chain}`.toLowerCase(),chain:n.chain.toLowerCase(),decimals:n.decimals,amount:n.value,price:n.current_price_usd,hasTokenInfo:!1,tokenType:1,chainMainCoinSymbol:"BNB",name:n.name}:{address:n.token.toLowerCase(),tokenId:`${n.token}-${n.chain}`.toLowerCase(),chain:n.chain.toLowerCase(),symbol:n.symbol,decimals:n.decimals,icon:N(n.chain.toLowerCase(),n.token.toLowerCase()),amount:n.value,price:n.current_price_usd,tokenType:0,chainMainCoinSymbol:"BNB",name:n.name};return null}async function ve(a,s){if(!s){o.isSelectSearchToken=!1;return}const _=K({message:"Loading...",forbidClick:!0,duration:0});try{const n=await ke(a,s);if(n==null){g("未找到代币/LP"),o.isSelectSearchToken=!1;return}o.isSelectSearchToken=!0,o.token=n}catch(n){console.log(n)}finally{_.close()}}return Ie(()=>{console.log("onMounted"),o.chainId>0&&(ae(),o.isConnectWallet&&o.token&&H())}),(a,s)=>{const _=S("van-cell"),n=S("van-cell-group"),C=S("van-button"),G=S("van-action-bar");return d(),y(q,null,[c(_e,{class:"query",onContractQuery:ve}),t("div",qe,[e(o).isSelectSearchToken?(d(),y("ul",Ke,[t("li",null,[ze,t("div",Je,i(e(o).token.name),1)]),t("li",null,[Xe,t("div",Ze,i(e(o).token.symbol),1)]),t("li",null,[eo,t("div",oo,[k(i(e(P)(e(o).token.address))+" ",1),c(pe,{class:"copy-icon",name:"copy",onClick:s[0]||(s[0]=u=>e(ye)(e(o).token.address))})])])])):(d(),B(n,{key:1,inset:"",class:"form-item"},{default:v(()=>[to,c(_,{"is-link":"",class:"token-cell",onClick:ue},Se({_:2},[e(o).token?{name:"title",fn:v(()=>[e(o).token.tokenType==0?(d(),y("div",no,[c(L,{class:"token-icon",tokenIcon:e(o).token.icon,chainIcon:e(Z)(e(o).token.chain)},null,8,["tokenIcon","chainIcon"]),k(" "+i(`${e(o).token.symbol} (${e(P)(e(o).token.address)})`),1)])):e(o).token.tokenType==1?(d(),y("div",so,[c(L,{class:"token-icon",tokenIcon:e(N)(e(o).token.chain,e(o).token.tokenList[0].address)},null,8,["tokenIcon"]),c(L,{class:"token-icon",tokenIcon:e(N)(e(o).token.chain,e(o).token.tokenList[1].address)},null,8,["tokenIcon"]),k(" "+i(`${e(o).token.symbol} (${e(P)(e(o).token.address)})`),1)])):te("",!0)]),key:"0"}:{name:"title",fn:v(()=>[t("div",{class:"token-box",style:{color:"#999999"}},i(a.$t("pleaseSelectToken")),1)]),key:"1"}]),1024)]),_:1})),c(n,{inset:"",class:"form-item"},{default:v(()=>[t("div",ao,[lo,t("div",null,[k("余额："),t("span",null,i(e(o).token?e(Y)(e(o).token.amount).toString().indexOf(".")==-1?e(Y)(e(o).token.amount):e(Y)(e(o).token.amount).toFixed(6):"--"),1)])]),t("div",null,[c(he,{amount:p.value,"onUpdate:amount":s[1]||(s[1]=u=>p.value=u),total:e(o).token?e(o).token.amount:0},null,8,["amount","total"])])]),_:1}),c(n,{inset:"",class:"form-item"},{default:v(()=>[co,t("div",null,[c(fe,{date:w.value,"onUpdate:date":s[2]||(s[2]=u=>w.value=u),showTools:""},null,8,["date"])])]),_:1})]),c(G,{class:"tools"},{default:v(()=>[e(o).isConnectWallet?(d(),y(q,{key:0},[l.value?(d(),B(C,{key:0,class:"btn",type:"danger",onClick:ce,block:"",loading:D.value},{default:v(()=>[k(i(a.$t("approve")),1)]),_:1},8,["loading"])):(d(),B(C,{key:1,class:"btn",color:"#3F80F7",onClick:ie,block:"",loading:x.value},{default:v(()=>[k("一键锁定")]),_:1},8,["loading"]))],64)):(d(),B(C,{key:1,class:"btn",type:"primary",onClick:le,block:""},{default:v(()=>[k(i(a.$t("connectWallet")),1)]),_:1}))]),_:1}),c(Qe,{show:M.value,"onUpdate:show":s[3]||(s[3]=u=>M.value=u),unlockDate:w.value,amount:p.value,showGas:j.value,onConfirm:de},null,8,["show","unlockDate","amount","showGas"]),c(me,{show:O.value,"onUpdate:show":s[4]||(s[4]=u=>O.value=u),txHash:W.value},null,8,["show","txHash"])],64)}}},po=ee(io,[["__scopeId","data-v-59040cb6"]]);export{po as default};
