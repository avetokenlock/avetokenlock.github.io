import{g as Z,T,f as E,a as O,b as P,d as de}from"./TokenIcon-0e28e022.js";import{_ as ee,d as oe,g as A,o as v,A as N,w as k,j as t,t as n,k as e,h as b,c,l as f,D as te,E as ue,b as ke,r as h,B as ve,H as fe,F as K,x as r,z as Q,L as V,O as q,N as x,P as J,M as pe,W as he,I as C}from"./index-4fde0403.js";/* empty css                                                              */import{I as me}from"./InputQty-5e5b092a.js";import{O as _e,S as we}from"./OperateSuccessDialog-5c4d6b75.js";import{B as X}from"./bignumber-3e8dfdf6.js";const ye={class:"ave-popup"},ge={class:"title"},Ce={class:"body"},be={class:"info"},$e={class:"key"},Ie={class:"value"},Ae={key:0,class:"token"},Te={key:1,class:"token"},De={key:2,class:"token"},Le={class:"key"},Se={class:"value"},Be={class:"key"},Pe={class:"value"},Ne={class:"key"},Ee={class:"value"},Oe={class:"blue-font"},Me={class:"key"},Ue={class:"value"},Ge={class:"tips"},Fe={__name:"LockConfirmPopup",props:{show:Boolean,showGas:String,amount:String,unlockDate:Date},emits:["update:show","confirm"],setup(w,{emit:d}){const M=w,l=oe();function D(){d("confirm")}return(i,L)=>{const o=A("van-button"),U=A("van-popup");return v(),N(U,{show:w.show,"onUpdate:show":L[0]||(L[0]=y=>{d("update:show",y)}),round:"",closeable:"",position:"bottom"},{default:k(()=>[t("div",ye,[t("div",ge,n(i.$t("lockConfirm")),1),t("div",Ce,[t("ul",be,[t("li",null,[t("div",$e,n(i.$t("lockAssets")),1),t("div",Ie,[e(l).token?e(l).token.tokenType==0?(v(),b("div",Te,[c(T,{class:"token-icon",tokenIcon:e(l).token.icon,chainIcon:e(Z)(e(l).token.chain)},null,8,["tokenIcon","chainIcon"]),f(" "+n(`${e(l).token.symbol} (${e(E)(e(l).token.address)})`),1)])):e(l).token.tokenType==1?(v(),b("div",De,[c(T,{class:"token-icon",tokenIcon:e(O)(e(l).token.chain,e(l).token.tokenList[0].address)},null,8,["tokenIcon"]),c(T,{class:"token-icon",tokenIcon:e(O)(e(l).token.chain,e(l).token.tokenList[1].address)},null,8,["tokenIcon"]),f(" "+n(`${e(l).token.symbol} (${e(E)(e(l).token.address)})`),1)])):te("",!0):(v(),b("div",Ae," -- "))])]),t("li",null,[t("div",Le,n(i.$t("lockNumber")),1),t("div",Se,n(w.amount),1)]),t("li",null,[t("div",Be,n(i.$t("contractChian")),1),t("div",Pe,n(e(l).token?e(l).token.chain.toUpperCase():"--"),1)]),t("li",null,[t("div",Ne,n(i.$t("unlockTime2")),1),t("div",Ee,[t("span",null,n(e(P)(w.unlockDate).format("YYYY-MM-DD")),1),t("span",null,[f("("),t("span",Oe,n(i.$t("dayLeft",{day:e(de)(M.unlockDate)})),1),f(")")])])]),t("li",null,[t("div",Me,n(i.$t("serviceFee")),1),t("div",Ue,n(e(l).token&&w.showGas?`${w.showGas} ${e(l).token.chainCoinSymbol.toUpperCase()}`:"--"),1)])]),t("div",Ge,[t("div",null,n(i.$t("createTips1")),1),t("div",null,n(i.$t("createTips2")),1),t("div",null,n(i.$t("createTips3")),1)]),c(o,{class:"btn",type:"primary",block:"",onClick:D},{default:k(()=>[f(n(i.$t("confirmAndLock")),1)]),_:1})])])]),_:1},8,["show"])}}},We=ee(Fe,[["__scopeId","data-v-bf62a0c7"]]);const He={class:"body"},Re={class:"title token-title"},Ve={key:0,class:"token-box"},Ye={key:1,class:"token"},je={class:"title"},ze={class:"title"},Ke={__name:"Create",setup(w){const{t:d}=ue(),M=ke("global"),l=h(!1),D=h(!1),i=h(!1),L=ve(),o=oe(),U=P().add(1,"day").endOf("day").toDate(),y=h(U),g=h(""),S=h(!1),Y=h(""),G=h(!1),F=h(""),$=h("");async function ne(){await o.connectWallet()}async function j(){if(o.token==null)return;if(o.token.address==r.wallet.MAIN_COIN_ADDRESS){l.value=!1;return}await r.wallet.isAllowanceEnough(o.lockContractAddress,o.token.address,o.walletAddress)?l.value=!1:l.value=!0}async function se(){D.value=!0;try{let s=await r.wallet.approveMaxAmount(o.token.address,o.lockContractAddress);console.log(s),await s.wait(),l.value=!1}catch(s){console.log(s)}finally{D.value=!1}}async function ae(){i.value=!0,F.value="";try{if(!o.token){C(d("pleaseSelectToken"));return}if(!g.value){C(d("enterAmount"));return}let s=M.cfg.allowChainList.find(a=>a.chain==o.token.chain);if(!s){C(d("tokenChainNotSupport"));return}if(o.chainId!=s.chainId){C(d("switchTokenChain"));try{await r.wallet.switchNetwork(s.chainId)}catch{C(d("switchTokenChain"));return}return}if(X(g.value).gt(X($.value))){C(d("balanceSlow"));return}if(await j(),l.value){C(d("approveFirst"));return}await le()}catch(s){console.log(s)}finally{i.value=!1}}async function le(){const s=o.token.address,a=r.wallet.getEthersProvider(),p=await r.wallet.contractByProvider(a,s,V).decimals(),_=o.walletAddress,B=o.token.tokenType==1,u=q(g.value,p),W=P(y.value).endOf("day").unix(),H="",R=r.wallet.contractByProvider(a,o.lockContractAddress,x),I=await a.getGasPrice();let z=await R.estimateGas.lock(_,s,B,u.toString(),W,H);console.dir(z),Y.value=J(z.mul(I)).toString(),S.value=!0}async function ce(){const s=Q({message:"Loading...",forbidClick:!0,duration:0}),a=o.token.address,m=o.walletAddress,p=r.wallet.getEthersProvider(),_=o.token.tokenType==1,u=await r.wallet.contractByProvider(p,a,V).decimals(),W=q(g.value,u),H=P(y.value).endOf("day").unix(),R=r.wallet.contractByProvider(p,o.lockContractAddress,x);try{let I=await R.lock(m,a,_,W.toString(),H,"");console.dir(I),F.value=I.hash,G.value=!0,S.value=!1}catch(I){console.log(I)}finally{s.close()}}function ie(){L.push("/selectToken")}async function re(){if(!o.token)return;const s=Q({message:"Loading...",forbidClick:!0,duration:0});try{const a=r.wallet.getEthersProvider();if(o.token.address==r.wallet.MAIN_COIN_ADDRESS){const m=await a.getBalance(o.walletAddress);$.value=J(m)}else{const m=r.wallet.contractByProvider(a,o.token.address,V),p=await m.decimals(),_=await m.balanceOf(o.walletAddress);$.value=pe(_,p)}}catch(a){console.log(a),o.token=null}finally{s.close()}}return fe(()=>{console.log("onMounted"),o.chainId>0&&o.isConnectWallet&&o.token&&(j(),re())}),(s,a)=>{const m=A("van-cell"),p=A("van-cell-group"),_=A("van-button"),B=A("van-action-bar");return v(),b(K,null,[t("div",He,[c(p,{inset:"",class:"form-item"},{default:k(()=>[t("div",Re,n(s.$t("selectToken2")),1),c(m,{"is-link":"",class:"token-cell",onClick:ie},he({_:2},[e(o).token?{name:"title",fn:k(()=>[e(o).token.tokenType==0?(v(),b("div",Ve,[c(T,{class:"token-icon",tokenIcon:e(o).token.icon,chainIcon:e(Z)(e(o).token.chain)},null,8,["tokenIcon","chainIcon"]),f(" "+n(`${e(o).token.symbol} (${e(E)(e(o).token.address)})`),1)])):e(o).token.tokenType==1?(v(),b("div",Ye,[c(T,{class:"token-icon",tokenIcon:e(O)(e(o).token.chain,e(o).token.tokenList[0].address)},null,8,["tokenIcon"]),c(T,{class:"token-icon",tokenIcon:e(O)(e(o).token.chain,e(o).token.tokenList[1].address)},null,8,["tokenIcon"]),f(" "+n(`${e(o).token.symbol} (${e(E)(e(o).token.address)})`),1)])):te("",!0)]),key:"0"}:{name:"title",fn:k(()=>[t("div",{class:"token-box",style:{color:"#999999"}},n(s.$t("pleaseSelectToken")),1)]),key:"1"}]),1024)]),_:1}),c(p,{inset:"",class:"form-item"},{default:k(()=>[t("div",je,[t("div",null,n(e(d)("setNumberOfLock")),1),t("div",null,[f(n(`${e(d)("balance")}: `),1),t("span",null,n($.value?$.value:"--"),1)])]),t("div",null,[c(me,{amount:g.value,"onUpdate:amount":a[0]||(a[0]=u=>g.value=u),total:$.value,decimals:e(o).token?e(o).token.decimals:0},null,8,["amount","total","decimals"])])]),_:1}),c(p,{inset:"",class:"form-item"},{default:k(()=>[t("div",ze,[t("div",null,n(s.$t("setDate")),1)]),t("div",null,[c(we,{date:y.value,"onUpdate:date":a[1]||(a[1]=u=>y.value=u),showTools:""},null,8,["date"])])]),_:1})]),c(B,{class:"tools"},{default:k(()=>[e(o).isConnectWallet?(v(),b(K,{key:0},[l.value?(v(),N(_,{key:0,class:"btn",type:"danger",onClick:se,block:"",loading:D.value},{default:k(()=>[f(n(s.$t("approve")),1)]),_:1},8,["loading"])):(v(),N(_,{key:1,class:"btn",color:"#3F80F7",onClick:ae,block:"",loading:i.value},{default:k(()=>[f(n(s.$t("oneKeyLock")),1)]),_:1},8,["loading"]))],64)):(v(),N(_,{key:1,class:"btn",type:"primary",onClick:ne,block:""},{default:k(()=>[f(n(s.$t("connectWallet")),1)]),_:1}))]),_:1}),c(We,{show:S.value,"onUpdate:show":a[2]||(a[2]=u=>S.value=u),unlockDate:y.value,amount:g.value,showGas:Y.value,onConfirm:ce},null,8,["show","unlockDate","amount","showGas"]),c(_e,{show:G.value,"onUpdate:show":a[3]||(a[3]=u=>G.value=u),txHash:F.value,onClose:a[4]||(a[4]=u=>e(L).push("/"))},null,8,["show","txHash"])],64)}}},eo=ee(Ke,[["__scopeId","data-v-b05d58dc"]]);export{eo as default};
