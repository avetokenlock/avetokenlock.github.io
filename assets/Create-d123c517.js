import{g as X,T as A,f as N,a as U,b as B,d as re}from"./TokenIcon-b7b0aeb5.js";import{_ as Z,d as ee,g as I,o as v,A as E,w as k,j as t,t as n,k as e,h as b,c,l as p,D as oe,E as de,b as ue,r as f,B as ke,H as ve,F as K,x as u,z as Q,L as Y,O as q,N as x,M as pe,W as he,I as C,P as fe}from"./index-26b7591a.js";/* empty css                                                              */import{I as me}from"./InputQty-7f7a3062.js";import{O as _e,S as ye}from"./OperateSuccessDialog-27ce1780.js";import{B as J}from"./bignumber-3e8dfdf6.js";const we={class:"ave-popup"},ge={class:"title"},Ce={class:"body"},be={class:"info"},$e={class:"key"},Ie={class:"value"},Ae={key:0,class:"token"},Te={key:1,class:"token"},Le={key:2,class:"token"},De={class:"key"},Se={class:"value"},Pe={class:"key"},Be={class:"value"},Ee={class:"key"},Ne={class:"value"},Ue={class:"blue-font"},Ge={class:"key"},Oe={class:"value"},Fe={class:"tips"},Me={__name:"LockConfirmPopup",props:{show:Boolean,showGas:String,amount:String,unlockDate:Date},emits:["update:show","confirm"],setup(_,{emit:r}){const G=_,l=ee();function T(){r("confirm")}return(i,L)=>{const o=I("van-button"),O=I("van-popup");return v(),E(O,{show:_.show,"onUpdate:show":L[0]||(L[0]=y=>{r("update:show",y)}),round:"",closeable:"",position:"bottom"},{default:k(()=>[t("div",we,[t("div",ge,n(i.$t("lockConfirm")),1),t("div",Ce,[t("ul",be,[t("li",null,[t("div",$e,n(i.$t("lockAssets")),1),t("div",Ie,[e(l).token?e(l).token.tokenType==0?(v(),b("div",Te,[c(A,{class:"token-icon",tokenIcon:e(l).token.icon,chainIcon:e(X)(e(l).token.chain)},null,8,["tokenIcon","chainIcon"]),p(" "+n(`${e(l).token.symbol} (${e(N)(e(l).token.address)})`),1)])):e(l).token.tokenType==1?(v(),b("div",Le,[c(A,{class:"token-icon",tokenIcon:e(U)(e(l).token.chain,e(l).token.tokenList[0].address)},null,8,["tokenIcon"]),c(A,{class:"token-icon",tokenIcon:e(U)(e(l).token.chain,e(l).token.tokenList[1].address)},null,8,["tokenIcon"]),p(" "+n(`${e(l).token.symbol} (${e(N)(e(l).token.address)})`),1)])):oe("",!0):(v(),b("div",Ae," -- "))])]),t("li",null,[t("div",De,n(i.$t("lockNumber")),1),t("div",Se,n(_.amount),1)]),t("li",null,[t("div",Pe,n(i.$t("contractChian")),1),t("div",Be,n(e(l).token?e(l).token.chain.toUpperCase():"--"),1)]),t("li",null,[t("div",Ee,n(i.$t("unlockTime2")),1),t("div",Ne,[t("span",null,n(e(B)(_.unlockDate).format("YYYY-MM-DD")),1),t("span",null,[p("("),t("span",Ue,n(i.$t("dayLeft",{day:e(re)(G.unlockDate)})),1),p(")")])])]),t("li",null,[t("div",Ge,n(i.$t("serviceFee")),1),t("div",Oe,n(e(l).token&&_.showGas?`${_.showGas} ${e(l).token.chainCoinSymbol.toUpperCase()}`:"--"),1)])]),t("div",Fe,[t("div",null,n(i.$t("createTips1")),1),t("div",null,n(i.$t("createTips2")),1),t("div",null,n(i.$t("createTips3")),1)]),c(o,{class:"btn",type:"primary",block:"",onClick:T},{default:k(()=>[p(n(i.$t("confirmAndLock")),1)]),_:1})])])]),_:1},8,["show"])}}},We=Z(Me,[["__scopeId","data-v-bf62a0c7"]]);const He={class:"body"},Ve={class:"title token-title"},Ye={key:0,class:"token-box"},je={key:1,class:"token"},Re={class:"title"},ze={class:"title"},Ke={__name:"Create",setup(_){const{t:r}=de(),G=ue("global"),l=f(!1),T=f(!1),i=f(!1),L=ke(),o=ee(),O=B().add(1,"day").endOf("day").toDate(),y=f(O),w=f(""),S=f(!1),j=f(""),F=f(!1),M=f(""),D=f("");async function te(){await o.connectWallet()}async function R(){console.log("checkAllowance"),await u.wallet.isAllowanceEnough(o.lockContractAddress,o.token.address,o.walletAddress)?l.value=!1:l.value=!0}async function ne(){T.value=!0;try{let s=await u.wallet.approveMaxAmount(o.token.address,o.lockContractAddress);console.log(s),await s.wait(),l.value=!1}catch(s){console.log(s)}finally{T.value=!1}}async function se(){i.value=!0,M.value="";try{if(!o.token){C(r("pleaseSelectToken"));return}if(!w.value){C(r("enterAmount"));return}let s=G.cfg.allowChainList.find(a=>a.chain==o.token.chain);if(!s){C(r("tokenChainNotSupport"));return}if(o.chainId!=s.chainId){C(r("switchTokenChain"));try{await u.wallet.switchNetwork(s.chainId)}catch{C(r("switchTokenChain"));return}return}if(J(w.value).gt(J(D.value))){C(r("balanceSlow"));return}if(await R(),l.value){C(r("approveFirst"));return}await ae()}catch(s){console.log(s)}finally{i.value=!1}}async function ae(){const s=o.token.address,a=u.wallet.getEthersProvider(),h=await u.wallet.contractByProvider(a,s,Y).decimals(),m=o.walletAddress,P=o.token.tokenType==1,d=q(w.value,h),W=B(y.value).endOf("day").unix(),H="",V=u.wallet.contractByProvider(a,o.lockContractAddress,x),$=await a.getGasPrice();let z=await V.estimateGas.lock(m,s,P,d.toString(),W,H);console.dir(z),j.value=fe(z.mul($)).toString(),S.value=!0}async function le(){const s=Q({message:"Loading...",forbidClick:!0,duration:0}),a=o.token.address,g=o.walletAddress,h=u.wallet.getEthersProvider(),m=o.token.tokenType==1,d=await u.wallet.contractByProvider(h,a,Y).decimals(),W=q(w.value,d),H=B(y.value).endOf("day").unix(),V=u.wallet.contractByProvider(h,o.lockContractAddress,x);try{let $=await V.lock(g,a,m,W.toString(),H,"");console.dir($),M.value=$.hash,F.value=!0,S.value=!1}catch($){console.log($)}finally{s.close()}}function ce(){L.push("/selectToken")}async function ie(){if(!o.token)return;const s=Q({message:"Loading...",forbidClick:!0,duration:0});try{const a=u.wallet.getEthersProvider(),g=u.wallet.contractByProvider(a,o.token.address,Y),h=await g.decimals(),m=await g.balanceOf(o.walletAddress);D.value=pe(m,h)}catch(a){console.log(a),o.token=null}finally{s.close()}}return ve(()=>{console.log("onMounted"),o.chainId>0&&o.isConnectWallet&&o.token&&(R(),ie())}),(s,a)=>{const g=I("van-cell"),h=I("van-cell-group"),m=I("van-button"),P=I("van-action-bar");return v(),b(K,null,[t("div",He,[c(h,{inset:"",class:"form-item"},{default:k(()=>[t("div",Ve,n(s.$t("selectToken2")),1),c(g,{"is-link":"",class:"token-cell",onClick:ce},he({_:2},[e(o).token?{name:"title",fn:k(()=>[e(o).token.tokenType==0?(v(),b("div",Ye,[c(A,{class:"token-icon",tokenIcon:e(o).token.icon,chainIcon:e(X)(e(o).token.chain)},null,8,["tokenIcon","chainIcon"]),p(" "+n(`${e(o).token.symbol} (${e(N)(e(o).token.address)})`),1)])):e(o).token.tokenType==1?(v(),b("div",je,[c(A,{class:"token-icon",tokenIcon:e(U)(e(o).token.chain,e(o).token.tokenList[0].address)},null,8,["tokenIcon"]),c(A,{class:"token-icon",tokenIcon:e(U)(e(o).token.chain,e(o).token.tokenList[1].address)},null,8,["tokenIcon"]),p(" "+n(`${e(o).token.symbol} (${e(N)(e(o).token.address)})`),1)])):oe("",!0)]),key:"0"}:{name:"title",fn:k(()=>[t("div",{class:"token-box",style:{color:"#999999"}},n(s.$t("pleaseSelectToken")),1)]),key:"1"}]),1024)]),_:1}),c(h,{inset:"",class:"form-item"},{default:k(()=>[t("div",Re,[t("div",null,n(e(r)("setNumberOfLock")),1),t("div",null,[p(n(`${e(r)("balance")}: `),1),t("span",null,n(D.value?D.value:"--"),1)])]),t("div",null,[c(me,{amount:w.value,"onUpdate:amount":a[0]||(a[0]=d=>w.value=d),total:D.value,decimals:e(o).token?e(o).token.decimals:0},null,8,["amount","total","decimals"])])]),_:1}),c(h,{inset:"",class:"form-item"},{default:k(()=>[t("div",ze,[t("div",null,n(s.$t("setDate")),1)]),t("div",null,[c(ye,{date:y.value,"onUpdate:date":a[1]||(a[1]=d=>y.value=d),showTools:""},null,8,["date"])])]),_:1})]),c(P,{class:"tools"},{default:k(()=>[e(o).isConnectWallet?(v(),b(K,{key:0},[l.value?(v(),E(m,{key:0,class:"btn",type:"danger",onClick:ne,block:"",loading:T.value},{default:k(()=>[p(n(s.$t("approve")),1)]),_:1},8,["loading"])):(v(),E(m,{key:1,class:"btn",color:"#3F80F7",onClick:se,block:"",loading:i.value},{default:k(()=>[p(n(s.$t("oneKeyLock")),1)]),_:1},8,["loading"]))],64)):(v(),E(m,{key:1,class:"btn",type:"primary",onClick:te,block:""},{default:k(()=>[p(n(s.$t("connectWallet")),1)]),_:1}))]),_:1}),c(We,{show:S.value,"onUpdate:show":a[2]||(a[2]=d=>S.value=d),unlockDate:y.value,amount:w.value,showGas:j.value,onConfirm:le},null,8,["show","unlockDate","amount","showGas"]),c(_e,{show:F.value,"onUpdate:show":a[3]||(a[3]=d=>F.value=d),txHash:M.value,onClose:a[4]||(a[4]=d=>e(L).push("/"))},null,8,["show","txHash"])],64)}}},eo=Z(Ke,[["__scopeId","data-v-263985ab"]]);export{eo as default};
