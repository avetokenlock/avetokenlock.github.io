import{g as q,T,f as E,a as F,b as P,d as lo}from"./TokenIcon-086da368.js";import{_ as J,d as X,g as I,o as k,A as N,w as u,j as t,t as n,k as o,h as b,c,l as v,D as Z,E as co,b as io,r as m,B as ro,H as uo,F as R,x as h,z as ko,L as z,O as K,N as Q,V as vo,I as C,P as po}from"./index-6717cc47.js";/* empty css                                                              */import{I as mo}from"./InputQty-04903e80.js";import{O as ho,S as fo}from"./InputQty.vuevuetypestyleindex0scoped2fedd184lang-7740704a.js";import{B}from"./bignumber-3e8dfdf6.js";const _o={class:"ave-popup"},yo={class:"title"},wo={class:"body"},go={class:"info"},Co={class:"key"},bo={class:"value"},$o={key:0,class:"token"},Io={key:1,class:"token"},To={key:2,class:"token"},Ao={class:"key"},Lo={class:"value"},Do={class:"key"},So={class:"value"},Bo={class:"key"},Po={class:"value"},No={class:"blue-font"},Eo={class:"key"},Fo={class:"value"},Go={class:"tips"},Oo={__name:"LockConfirmPopup",props:{show:Boolean,showGas:String,amount:String,unlockDate:Date},emits:["update:show","confirm"],setup(f,{emit:r}){const G=f,s=X();function A(){r("confirm")}return(i,L)=>{const e=I("van-button"),O=I("van-popup");return k(),N(O,{show:f.show,"onUpdate:show":L[0]||(L[0]=_=>{r("update:show",_)}),round:"",closeable:"",position:"bottom"},{default:u(()=>[t("div",_o,[t("div",yo,n(i.$t("lockConfirm")),1),t("div",wo,[t("ul",go,[t("li",null,[t("div",Co,n(i.$t("lockAssets")),1),t("div",bo,[o(s).token?o(s).token.tokenType==0?(k(),b("div",Io,[c(T,{class:"token-icon",tokenIcon:o(s).token.icon,chainIcon:o(q)(o(s).token.chain)},null,8,["tokenIcon","chainIcon"]),v(" "+n(`${o(s).token.symbol} (${o(E)(o(s).token.address)})`),1)])):o(s).token.tokenType==1?(k(),b("div",To,[c(T,{class:"token-icon",tokenIcon:o(F)(o(s).token.chain,o(s).token.tokenList[0].address)},null,8,["tokenIcon"]),c(T,{class:"token-icon",tokenIcon:o(F)(o(s).token.chain,o(s).token.tokenList[1].address)},null,8,["tokenIcon"]),v(" "+n(`${o(s).token.symbol} (${o(E)(o(s).token.address)})`),1)])):Z("",!0):(k(),b("div",$o," -- "))])]),t("li",null,[t("div",Ao,n(i.$t("lockNumber")),1),t("div",Lo,n(f.amount),1)]),t("li",null,[t("div",Do,n(i.$t("contractChian")),1),t("div",So,n(o(s).token?o(s).token.chain.toUpperCase():"--"),1)]),t("li",null,[t("div",Bo,n(i.$t("unlockTime2")),1),t("div",Po,[t("span",null,n(o(P)(f.unlockDate).format("YYYY-MM-DD")),1),t("span",null,[v("("),t("span",No,n(i.$t("dayLeft",{day:o(lo)(G.unlockDate)})),1),v(")")])])]),t("li",null,[t("div",Eo,n(i.$t("serviceFee")),1),t("div",Fo,n(o(s).token&&f.showGas?`${f.showGas} ${o(s).token.chainCoinSymbol.toUpperCase()}`:"--"),1)])]),t("div",Go,[t("div",null,n(i.$t("createTips1")),1),t("div",null,n(i.$t("createTips2")),1),t("div",null,n(i.$t("createTips3")),1)]),c(e,{class:"btn",type:"primary",block:"",onClick:A},{default:u(()=>[v(n(i.$t("confirmAndLock")),1)]),_:1})])])]),_:1},8,["show"])}}},Uo=J(Oo,[["__scopeId","data-v-bf62a0c7"]]);const Mo={class:"body"},Vo={class:"title token-title"},Wo={key:0,class:"token-box"},Ho={key:1,class:"token"},Yo={class:"title"},jo={class:"title"},xo={__name:"Create",setup(f){const{t:r}=co(),G=io("global"),s=m(!1),A=m(!1),i=m(!1),L=ro(),e=X(),O=P().add(1,"day").endOf("day").toDate(),_=m(O),y=m(""),D=m(!1),Y=m(""),U=m(!1),M=m("");async function oo(){await e.connectWallet()}async function j(){console.log("checkAllowance"),await h.wallet.isAllowanceEnough(e.lockContractAddress,e.token.address,e.walletAddress)?s.value=!1:s.value=!0}async function eo(){A.value=!0;try{let a=await h.wallet.approveMaxAmount(e.token.address,e.lockContractAddress);console.log(a),await a.wait(),s.value=!1}catch(a){console.log(a)}finally{A.value=!1}}async function to(){i.value=!0,M.value="";try{if(!e.token){C(r("pleaseSelectToken"));return}if(!y.value){C(r("enterAmount"));return}let a=G.cfg.allowChainList.find(w=>w.chain==e.token.chain);if(!a){C(r("tokenChainNotSupport"));return}if(e.chainId!=a.chainId){C(r("switchTokenChain"));try{await h.wallet.switchNetwork(a.chainId)}catch{C(r("switchTokenChain"));return}return}if(Number(y)>e.token.amount){C(r("blanceSlow"));return}if(await j(),s.value){C(r("approveFirst"));return}await no()}catch(a){console.log(a)}finally{i.value=!1}}async function no(){const a=e.token.address,l=h.wallet.getEthersProvider(),p=await h.wallet.contractByProvider(l,a,z).decimals();console.log(p);const g=e.walletAddress,S=e.token.tokenType==1,d=K(y.value,p),V=P(_.value).endOf("day").unix(),W="",H=h.wallet.contractByProvider(l,e.lockContractAddress,Q),$=await l.getGasPrice();let x=await H.estimateGas.lock(g,a,S,d.toString(),V,W);console.dir(x),Y.value=po(x.mul($)).toString(),D.value=!0}async function so(){const a=ko({message:"Loading...",forbidClick:!0,duration:0}),l=e.token.address,w=e.walletAddress,p=h.wallet.getEthersProvider(),g=e.token.tokenType==1,d=await h.wallet.contractByProvider(p,l,z).decimals(),V=K(y.value,d),W=P(_.value).endOf("day").unix(),H=h.wallet.contractByProvider(p,e.lockContractAddress,Q);try{let $=await H.lock(w,l,g,V.toString(),W,"");console.dir($),M.value=$.hash,U.value=!0,D.value=!1}catch($){console.log($)}finally{a.close()}}function ao(){L.push("/selectToken")}return uo(()=>{console.log("onMounted"),e.chainId>0&&e.isConnectWallet&&e.token&&j()}),(a,l)=>{const w=I("van-cell"),p=I("van-cell-group"),g=I("van-button"),S=I("van-action-bar");return k(),b(R,null,[t("div",Mo,[c(p,{inset:"",class:"form-item"},{default:u(()=>[t("div",Vo,n(a.$t("selectToken2")),1),c(w,{"is-link":"",class:"token-cell",onClick:ao},vo({_:2},[o(e).token?{name:"title",fn:u(()=>[o(e).token.tokenType==0?(k(),b("div",Wo,[c(T,{class:"token-icon",tokenIcon:o(e).token.icon,chainIcon:o(q)(o(e).token.chain)},null,8,["tokenIcon","chainIcon"]),v(" "+n(`${o(e).token.symbol} (${o(E)(o(e).token.address)})`),1)])):o(e).token.tokenType==1?(k(),b("div",Ho,[c(T,{class:"token-icon",tokenIcon:o(F)(o(e).token.chain,o(e).token.tokenList[0].address)},null,8,["tokenIcon"]),c(T,{class:"token-icon",tokenIcon:o(F)(o(e).token.chain,o(e).token.tokenList[1].address)},null,8,["tokenIcon"]),v(" "+n(`${o(e).token.symbol} (${o(E)(o(e).token.address)})`),1)])):Z("",!0)]),key:"0"}:{name:"title",fn:u(()=>[t("div",{class:"token-box",style:{color:"#999999"}},n(a.$t("pleaseSelectToken")),1)]),key:"1"}]),1024)]),_:1}),c(p,{inset:"",class:"form-item"},{default:u(()=>[t("div",Yo,[t("div",null,n(o(r)("setNumberOfLock")),1),t("div",null,[v(n(`${o(r)("balance")}: `),1),t("span",null,n(o(e).token?o(B)(o(e).token.amount).toString().indexOf(".")==-1?o(B)(o(e).token.amount):o(B)(o(e).token.amount).toFixed(6,1):"--"),1)])]),t("div",null,[c(mo,{amount:y.value,"onUpdate:amount":l[0]||(l[0]=d=>y.value=d),total:o(e).token?Number(o(B)(o(e).token.amount).toFixed(6,1)):0},null,8,["amount","total"])])]),_:1}),c(p,{inset:"",class:"form-item"},{default:u(()=>[t("div",jo,[t("div",null,n(a.$t("setDate")),1)]),t("div",null,[c(fo,{date:_.value,"onUpdate:date":l[1]||(l[1]=d=>_.value=d),showTools:""},null,8,["date"])])]),_:1})]),c(S,{class:"tools"},{default:u(()=>[o(e).isConnectWallet?(k(),b(R,{key:0},[s.value?(k(),N(g,{key:0,class:"btn",type:"danger",onClick:eo,block:"",loading:A.value},{default:u(()=>[v(n(a.$t("approve")),1)]),_:1},8,["loading"])):(k(),N(g,{key:1,class:"btn",color:"#3F80F7",onClick:to,block:"",loading:i.value},{default:u(()=>[v(n(a.$t("oneKeyLock")),1)]),_:1},8,["loading"]))],64)):(k(),N(g,{key:1,class:"btn",type:"primary",onClick:oo,block:""},{default:u(()=>[v(n(a.$t("connectWallet")),1)]),_:1}))]),_:1}),c(Uo,{show:D.value,"onUpdate:show":l[2]||(l[2]=d=>D.value=d),unlockDate:_.value,amount:y.value,showGas:Y.value,onConfirm:so},null,8,["show","unlockDate","amount","showGas"]),c(ho,{show:U.value,"onUpdate:show":l[3]||(l[3]=d=>U.value=d),txHash:M.value,onClose:l[4]||(l[4]=d=>o(L).push("/"))},null,8,["show","txHash"])],64)}}},Xo=J(xo,[["__scopeId","data-v-95106dde"]]);export{Xo as default};
